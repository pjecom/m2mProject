<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "C:\m2m_project\workspace\mybatis-3-mapper.dtd">

<mapper namespace="com.m2m.fo.bo.mapper.BoMberMngMapper">
    <select id="getBoCommCdList" resultType="com.m2m.fo.bo.model.BoCoCommCdVO">
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        /* com.m2m.fo.bo.mapper.BoMberMngMapper.getBoCommCdList */
        SELECT　
            MAIN_CODE
            ,SUB_CODE
            ,CODE_NM
            ,CODE_DCONE
            ,CODE_DCTWO
            ,(
                SELECT COUNT(*)
                FROM BD_ENTRPS_INFO_BAS beib
                WHERE
                    SUB_CODE = BID_MBER_STTUS_CODE
                    AND MAIN_CODE = 'BID_MBER_STTUS_CODE'
                    AND beib.DELETE_AT = 'N'
            ) AS CODE_LT
        FROM CO_CMMN_CD
    </select>
    <select id="getMberList" parameterType="com.m2m.fo.bo.model.BoMberVO" resultType="com.m2m.fo.bo.model.BoMberVO">
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        /* com.m2m.fo.bo.mapper.BoMberMngMapper.getMberList */
        SELECT
            ROW_NUMBER() OVER(
                ORDER BY ETR_CONFM_REQUST_DT DESC
            ) AS ROW_NUM,                                   -- 순번
            BID_ENTRPS_NO,                                  -- 입찰 업체 번호
            ENTRPS_NM,                                      -- 업체 명
            BID_MBER_ID,                                    -- 입찰 회원 아이디
            BSNM_REGIST_NO,                                 -- 사업자 번호
            BID_MBER_EMAIL,                                 -- 입찰 회원 이메일
            MOBLPHON_NO2,                                   -- 휴대폰 번호
            FRNTN_ENTRPS_AT,                                -- 외국 업체 여부
            ETR_CONFM_REQUST_DT,                            -- 승인요청일
            ETR_CONFM_PROCESS_DT,                           -- 승인처리일
            beib.BID_MBER_INTRCP_DT,                        -- 차단일
            (
                SELECT COUNT(*)
                FROM BD_BDDPR_DTL bbd
                WHERE
                    beib.BID_ENTRPS_NO = bbd.BID_ENTRPS_NO
                    AND SCSBID_AT = 'Y'
            ) as BD_SCS_CNT,                                -- 낙찰 건수
            (
                SELECT COUNT(*)
                FROM BD_BDDPR_DTL bbd
                WHERE
                    beib.BID_ENTRPS_NO = bbd.BID_ENTRPS_NO
                    AND SCSBID_AT = 'N'
            ) as BD_FAIL_CNT,                               -- 패찰 건수
            (
                SELECT CODE_DCTWO
                FROM CO_CMMN_CD ccc
                WHERE
                    ccc.MAIN_CODE = 'BID_MBER_STTUS_CODE'
                    AND ccc.SUB_CODE = beib.BID_MBER_STTUS_CODE
            ) as BID_MBER_STTUS,                            -- 입찰 회원 상태 명
            (
                SELECT CODE_DCTWO
                FROM CO_CMMN_CD ccc
                WHERE
                    ccc.MAIN_CODE = 'BID_CONFM_STTUS_CODE'
                    AND ccc.SUB_CODE = beib.BID_CONFM_STTUS_CODE
            ) AS BID_CONFM_STTUS				            -- 입찰 승인 상태명
        FROM BD_ENTRPS_INFO_BAS beib
        where DELETE_AT = 'N'
        <choose>
            <when test='bidMberSttusCode == null || bidMberSttusCode.equals("")'>
                AND beib.BID_MBER_STTUS_CODE != '03'
            </when>
            <otherwise>
                AND beib.BID_MBER_STTUS_CODE = #{bidMberSttusCode}
            </otherwise>
        </choose>
        <if test="schGubun != null">
            <choose>
                <when test='schGubun.equals("entrpsNm")'>
                    AND ENTRPS_NM LIKE '%' + #{schData} + '%'
                </when>
                <when test='schGubun.equals("bsnmRegistNo")'>
                    AND BSNM_REGIST_NO LIKE '%' + #{schData} + '%'
                </when>
                <when test='schGubun.equals("bidMberId")'>
                    AND BID_MBER_ID LIKE '%' + #{schData} + '%'
                </when>
                <otherwise>
                    AND (
                    ENTRPS_NM LIKE '%' + #{schData} + '%'
                    OR BSNM_REGIST_NO LIKE '%' + #{schData} + '%'
                    OR BID_MBER_ID LIKE '%' + #{schData} + '%'
                    )
                </otherwise>
            </choose>
        </if>
        <if test="etrConfmRequstDt != null">
            <![CDATA[
                AND ETR_CONFM_REQUST_DT >= #{etrConfmRequstDt}
            ]]>
        </if>
        <if test="etrConfmProcessDt != null">
            <![CDATA[
                AND ETR_CONFM_REQUST_DT <= #{etrConfmProcessDt}
            ]]>
        </if>
        ORDER BY ETR_CONFM_REQUST_DT DESC
    </select>
    <select id="getMberDtl" parameterType="String" resultType="com.m2m.fo.bo.model.BoMberVO">
        SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        /* com.m2m.fo.bo.mapper.BoMberMngMapper.getMberDtl */
        SELECT
            BID_ENTRPS_NO, 						-- 입찰 업체 번호
            ENTRPS_NM, 							-- 업체 명
            FRNTN_ENTRPS_AT, 					-- 외국 업체 여부
            BSNM_REGIST_NO, 					-- 사업자 번호
            BID_MBER_ID, 						-- 입찰 회원 아이디
            BID_MBER_EMAIL, 					-- 입찰 회원 이메일
            MOBLPHON_NO2, 						-- 휴대폰 번호
            VRSC_ENTRPS_NM, 					-- 대행 업체 명
            VRSC_BSNM_REGIST_NO, 				-- 대행 사업자등록번호
            VRSC_BID_MBER_EMAIL,                -- 대행 이메일
            VRSC_MOBLPHON_NO,                   -- 대행 휴대폰번호
            ETR_CONFM_REQUST_DT,                -- 승인요청일
            ETR_CONFM_PROCESS_DT,               -- 승인처리일
            (
                SELECT CODE_DCTWO
                FROM CO_CMMN_CD ccc
                WHERE
                    ccc.MAIN_CODE = 'BID_MBER_STTUS_CODE'
                    AND ccc.SUB_CODE = beib.BID_MBER_STTUS_CODE
            ) as BID_MBER_STTUS, 				-- 입찰 회원 상태명
            beib.BID_MBER_INTRCP_DT, 			-- 차단일
            (
                SELECT CODE_DCTWO
                FROM CO_CMMN_CD ccc
                WHERE
                    ccc.MAIN_CODE = 'BID_CONFM_STTUS_CODE'
                    AND ccc.SUB_CODE = beib.BID_CONFM_STTUS_CODE
            ) AS BID_CONFM_STTUS				-- 입찰 승인 상태명
        FROM BD_ENTRPS_INFO_BAS beib
        where BID_ENTRPS_NO = #{bidEntrpsNo}
    </select>
    <select id="beforeIntrcpMber" parameterType="String" resultType="int">
        <![CDATA[
            SELECT count(*)
            FROM BD_BDDPR_DTL bbd
            WHERE
                bbd.BID_ENTRPS_NO  = #{bidEntrpsNo}
                AND BDDPR_NRMLT_AT = 'Y'      	        -- 투찰 정상 여부
                AND (
                    SCSBID_AT = 'N'				        -- 낙찰 여부
                        OR (
                            SCSBID_AT = 'Y'
                        AND (					        -- 심사 완료 체크
                                SELECT JDGMN_COMPT_DT
                                FROM BD_SCSBID_DTL bsd
                                WHERE bsd.BID_ENTRPS_NO = #{bidEntrpsNo}
                        ) < getDate()
                    )
                )
                AND CANCL_AT = 'N'				        -- 취소 여부
                AND DELETE_AT = 'N'				        -- 삭제 여부
        ]]>
    </select>
    <update id="intrcpMber" parameterType="String">
        UPDATE
            BD_ENTRPS_INFO_BAS
        SET
            BID_MBER_STTUS_CODE = '02',
            BID_MBER_INTRCP_DT = getDate()
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </update>
    <update id="unlockMber" parameterType="String">
        UPDATE
            BD_ENTRPS_INFO_BAS
        SET
            BID_MBER_STTUS_CODE = '01',
            BID_MBER_INTRCP_DT = null
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </update>
    <update id="rejectMber" parameterType="String">
        UPDATE
            BD_ENTRPS_INFO_BAS
        SET
            BID_MBER_STTUS_CODE = '03',
            BID_CONFM_STTUS_CODE = '02',
            ETR_CONFM_PROCESS_DT = getDate()
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </update>
    <update id="confmMber" parameterType="String">
        UPDATE
            BD_ENTRPS_INFO_BAS
        SET
            BID_MBER_STTUS_CODE = '01',
            BID_CONFM_STTUS_CODE = '03',
            ETR_CONFM_PROCESS_DT = getDate()
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </update>
</mapper>